<div class="page">
  <div class="header">
    <h1 class="header__title">
      Заказ №{{ order?.id }}
    </h1>

    <div class="header__toolbar">
      <button class="header__btn toolbar-btn" (click)="goBack()" type="button">
        <i class="ai ai-arrow-left"></i> назад
      </button>

      <ng-container *ngIf="order">
        <app-button class="header__btn" (click)="reorder()" type="button">
          Повторить заказ
        </app-button>
        <app-button class="header__btn" (click)="printOrder()" type="button">
          Распечатать PDF
        </app-button>
        <app-button class="header__btn" *ngIf="isCancelOrderVisible()" (click)="cancelOrder()" type="button">
          Отменить заказ
        </app-button>
        <app-button class="header__btn" *ngIf="isEditOrderVisible()" (click)="editOrder()" type="button">
          Редактировать
        </app-button>
        <!--
        <app-button class="header__btn" *ngIf="isStartOrderVisible()" (click)="startOrder()" btnStyle="primary" type="button">
          Принять в работу
        </app-button>
        -->
        <app-button class="header__btn" *ngIf="isShipOrderVisible()" (click)="openShipmentInfo()" btnStyle="primary" type="button">
          Отправить заказ
        </app-button>
      </ng-container>
    </div>
  </div>

  <div class="order-view" *ngIf="customer">
    <div class="order-view__subtitle">
      Заказ
    </div>
    <div class="order-view__block two-col">
      <div class="two-col__col info-table">
        <div class="info-table__row">
          <div class="info-table__block">Дата заказа</div>
          <div class="info-table__block">{{ order.createdAt | date }}</div>
        </div>
        <div class="info-table__row">
          <div class="info-table__block">Статус заказа</div>
          <div class="info-table__block">{{ order.status }}</div>
        </div>
        <div class="info-table__row">
          <div class="info-table__block">Оплачен ли товар поставщику</div>
          <div class="info-table__block"></div>
        </div>
      </div>

      <div class="two-col__col info-table">
        <div class="info-table__row">
          <div class="info-table__block">Комментарий менеджера</div>
          <div class="info-table__block">{{ order.adminNote }}</div>
        </div>
        <div class="info-table__row">
          <div class="info-table__block">Нужно ли связываться с клиентом для подтверждения заказа?</div>
          <div class="info-table__block">{{ order.isCallbackNeeded ? 'Да' : 'Нет' }}</div>
        </div>
        <div class="info-table__row">
          <div class="info-table__block">Комментарий клиента</div>
          <div class="info-table__block">{{ order.clientNote }}</div>
        </div>
      </div>
    </div>

    <div class="order-view__subtitle">
      Новая Почта

      <button class="order-view__edit-tracking" *ngIf="!trackingIdControl" (click)="openTrackingIdForm()">
        изменить
      </button>

      <button class="order-view__edit-tracking" *ngIf="!trackingIdControl" (click)="updateShipmentStatus()">
        обновить статус
      </button>
    </div>

    <div class="order-view__block">
      <div class="tracking">
        <div class="tracking__control" *ngIf="trackingIdControl; else trackingIdTmpl">
          <input class="tracking__input" [formControl]="trackingIdControl" type="text" autofocus>

          <button class="order-view__edit-tracking" (click)="updateTrackingId()">
            сохранить
          </button>

          <button class="order-view__edit-tracking" (click)="closeTrackingIdForm()">
            отменить
          </button>
        </div>

        <ng-template #trackingIdTmpl>
          <span class="order-view__no-tracking-number" *ngIf="!order.shipment.trackingNumber; else hasNumberTmpl">
            - Нет номера ТТН -
          </span>

          <ng-template #hasNumberTmpl>
            {{ order.shipment.trackingNumber }} - {{ order.shipment.statusDescription }}
          </ng-template>
        </ng-template>
      </div>
    </div>

    <div class="order-view__subtitle">
      Адрес

      <button class="order-view__edit-address" (click)="openAddressForm()">
        изменить
      </button>
    </div>

    <div class="order-view__block order-view__address">
      {{ order.shipment.recipient.firstName }} {{ order.shipment.recipient.lastName }}, {{ order.shipment.recipient.phone | normalizedPhone }}
      <br>
      {{ order.shipment.recipient.settlement }}, {{ order.shipment.recipient.address }}<ng-container *ngIf="order.shipment.recipient.buildingNumber as buildingNumber">, {{ buildingNumber }} {{ order.shipment.recipient.flat }}</ng-container>
    </div>

    <div class="order-view__subtitle">
      Оплата и доставка
    </div>

    <div class="order-view__block two-col">
      <div class="two-col__col method">
        <div class="method__title">Способ оплаты</div>
        <div class="method__name">{{ order.paymentMethodAdminName }}</div>
      </div>
      <div class="two-col__col method">
        <div class="method__title">Способ доставки</div>
        <div class="method__name">{{ order.shippingMethodName }}</div>
      </div>
    </div>

    <div class="order-view__subtitle">
      Товары в заказе
    </div>

    <div class="order-view__block">
      <table class="items-table">
        <thead>
          <tr class="items-table__row items-table__row--head">
            <td class="items-table__block items-table__block--img">Фото</td>
            <td class="items-table__block items-table__block--name">Название</td>
            <td class="items-table__block items-table__block--price">Цена</td>
            <td class="items-table__block items-table__block--qty">Кол-во</td>
            <td class="items-table__block items-table__block--cost">Стоимость</td>
            <td class="items-table__block items-table__block--discount">Скидка</td>
            <td class="items-table__block items-table__block--total">Итого</td>
          </tr>
        </thead>
        <tbody>
          <tr class="items-table__row"
               *ngFor="let item of order.items, even as even"
               [class.items-table__row--even]="even"
          >
            <td class="items-table__block items-table__block--img">
              <img class="items-table__img"
                   *ngIf="item.imageUrl"
                   [src]="uploadedHost + item.imageUrl">
            </td>
            <td class="items-table__block items-table__block--name">
              {{ item.name }}
            </td>
            <td class="items-table__block items-table__block--price">
              {{ item.price }} грн<ng-container *ngIf="item.price !== item.originalPrice"> ({{ item.originalPrice }} грн)</ng-container>
            </td>
            <td class="items-table__block items-table__block--qty">
              <div class="items-table__qty">{{ item.qty }}</div>
            </td>
            <td class="items-table__block items-table__block--cost">
              {{ item.cost }} грн
            </td>
            <td class="items-table__block items-table__block--discount">
              {{ item.discountValue }} грн
            </td>
            <td class="items-table__block items-table__block--total">
              {{ item.totalCost }} грн
            </td>
          </tr>
        </tbody>
      </table>
      <div class="total-order-cost">
        {{ order.totalCost }} грн
      </div>
    </div>
  </div>
</div>

<div class="address-form" *ngIf="isAddressFormVisible">
  <div class="modal-overlay" (click)="closeAddressForm()"></div>
  <div class="modal address-form__modal">
    <div class="modal__header">
      <div class="modal__title">
        Изменить адрес
      </div>
      <div class="modal__close" (click)="closeAddressForm()">
        <i class="ai ai-multiply modal__close-icon"></i>
      </div>
    </div>

    <div class="modal__content">
      <address-form class="address-form__form" [address]="order.shipment.recipient" [showIsDefault]="false"></address-form>

      <div class="address-form__submit-container">
        <app-button class="address-form__submit" (click)="submitAddressForm()" btnStyle="primary">
          Сохранить
        </app-button>
      </div>
    </div>
  </div>
</div>

<shipment-info-modal *ngIf="order"
                     [shipment]="order.shipment"
                     [cost]="order.totalCost"
                     (infoSubmit)="onShipmentInfoSubmit($event)"
></shipment-info-modal>

<preloader class="preloader" *ngIf="!customer || isLoading" [hasMargins]="false"></preloader>
